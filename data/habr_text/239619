'239619 |@words шахматный:2 программа:2 широко использоваться битовый доска:6 битборд:3 для:16 представление фигура:2 так:7 другой:2 игра:2 тот:4 8×8 даже:2 карточный часто:2 проводить различный операция:3 например:3 найти:4 один:7 установленный:2 битый:3 или:3 посчитать количество битов этот:5 придумать много:3 хитрый алгоритм:4 современный процессор:5 некоторый:2 доступный:6 расширить набор инструкция:15 popcnt:8 sse4 abm также:2 есть:5 пара bsf:5 bsr:5 который:8 уже:4 давно jit-компилятор он:8 нет:2 никакой доступ конечно весь:6 серьёзный писать c++:2 прототипирование какой-нибудь хотеться:2 использовать:4 потому что:15 хороший:4 знак я маленький шанс выстрелить себя нога производительность:2 тоже:4 терять просто:2 интересовать мы:9 называть встроить функция:6 попробовать:2 сделать:3 подобный решение:2 simd готовый:2 библиотека:2 манпуляция бит делать:2 надо:11 как-то пропатчить:2 иметься код:11 остановиться 64-битный:2 32х битный весело работать:3 процесор x86:3 несовместимый архитектура:2 иметь фоллбэк:3 реализация:2 при:3 такой:5 условие:2 быть:13 всегда недоступный только:4 довольно:5 древний железо это:17 поздний самый:3 простой вариант:4 написать:3 dll:2 с++ экспортировать оттуда нужный:6 состоять вокруг они:3 несколько лишний:2 джамп возникнуть pinvoke:2 два:3 getdelegateforfunctionpointer:2 похожий требовать отдельный нативный три подменять скомпилировать:3 метод:9 про интересный стать тут:5 возникать проблема тем сложно появляться зависимость:2 внутренность рантайм:2 следовательно версия итог:2 получать громоздкий нестбильный наш:9 путь оставаться последний патчить:2 jit-ом деталь:2 начало:3 убедиться runtimehelpers:2 preparemethod:2 чтобы:2 добраться машинный майкрософт заботливо предоставить runtimemethodhandle getfunctionpointer:2 ссылка мочь:3 оказаться:2 как:6 сам трамплин:2 хорошо бывать вид:2 jmp:3 воспользоваться static:2 byte:3 getmethodptr methodinfo method:3 methodhandle:2 var:5 ptr:14 skip all jumps while:2 0xe9:2 delta:4 int:3 return итак адрес:6 получить:2 записать туда что-нибудь:2 учесть call-convention благо четыре аргумент:3 rcx:4 rdx:2 результат:2 rax:8 ret:2 ptr++:5 0x48 0x0f 0xbd 0xc1 0xc3 пробовать ура сейчас:2 ничто:4 отличаться call:7 вызывающий если:8 функция-фоллбэк компилятор зайинлайнить патч:2 данный:2 место:5 помочь инлайна можно:4 легко:3 отказаться:2 помощь:2 атрибут:2 methodimpl methodimploptions noinlining ещё:3 с++-intrinsics необходимый полностью справиться правда прийтись немного испачкать рука:2 ассемблер:2 вызов:6 лёт подменить патчер параметр какой заменить:4 начать:2 определение возврат:3 стэк:3 dword обычно:2 случается раз:3 перед она:2 проверить:7 предыдущий байт:3 действительно целиком опкод метод-патчер выглядеть:2 вот:4 void patchcallsite:2 rsp:4 ulong:5 code:4 check:2 opcode 0xe8 throw:2 error:2 const mask5bytes:4 1ul ~mask5bytes вызывать:2 вручную фоллбэк-метод штука заменять:2 nop дополнить push сохранить ответ:2 sub 0x20:3 под:2 register spilling mov:2 qword:2 rsp+0x28 вход функия уползти rip-0x16 менять ссылаться кусок:2 movabs add поправлять обратно pop доставать заниматься patcher:2 patchmethod вызвать:2 живой пример:2 perftest картинка:2 видно:2 после первое проход теперь остаться:2 мелочь jit куда-нибудь очень:2 сильно заинлайнить tail-call оптимизация:2 тогда очень-то соответствовать сожаление смочь агрессивный всякий случай:2 проверять:2 знать откуда совершить дело перепрыгнуть через jmp-ы привести благодаря поместить неизменный target calltarget:5 желательно:2 трогать вдруг неподдерживаемый вообще:2 intptr size далёкий удостовериться чем сравнить пролог люба заведомо верный verifyprologue вы:2 важный скорость оставить фолл-бэк интеловский мануал наличие cpuid:2 eax=01h ecx bit приходить stackoverflow-driven development где:2 красиво завернуть replacewith cpiud1ecx клеить фолбэк-функция немой содержаться intrinsic доступность бенчмарка:2 примитивный генерировать массив псевдо-случайный число потом гонять 100миллион каждый исключить влияние цикл:3 прочий обвязка сначала измерять время:2 пустой отдельно протестировать специальный разредить содержимый пометить клетка текущий выбрать фолбэк должный отрабатывать быстрый померять ноутбучный старый добрый q6600:3 тест i7-3667u:2 testing:18 rng:2 78ms sum=369736839:2 bitscanforward:4 123ms sum=99768073:4 fallback:12 239ms popcnt64:12 106ms:3 sum=-1092098543:4 3143ms popcnt32:6 sum=1598980778:4 2139ms sparse:6 data:4 sum=758117720:4 952ms patch status feature:2 not:2 supported:2 this:2 cpu:2 92ms 154ms 323ms 3832ms 3583ms 2414ms 3249ms 1662ms 1076ms сводный таблица вычесть холостой 45ms 161ms slower:5 28ms:3 3065ms ~100x 2061ms ~70x 874ms ~30x 62ms 231ms 3491ms 3157ms 984ms видеть достаточно быстро прирост интринсик небольшой незаметный фон часть намного core ускориться десятка применительно конечный ускорение всего-лишь там считать говориться ymmv свой взять:2 гитхаб nuget install-package netintrinsics